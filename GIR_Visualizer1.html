<script>
const svg = d3.select("svg"),
      margin = {top: 20, right: 120, bottom: 20, left: 120},
      width = +svg.attr("width") - margin.left - margin.right,
      height = +svg.attr("height") - margin.top - margin.bottom;

const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

const treeLayout = d3.tree().size([height, width]);

const root = d3.hierarchy(treeData);

treeLayout(root);

// Links
g.selectAll(".link")
  .data(root.links())
  .enter().append("path")
    .attr("class", "link")
    .attr("d", d3.linkHorizontal()
        .x(d => d.y)
        .y(d => d.x));

// Nodes
const node = g.selectAll(".node")
  .data(root.descendants())
  .enter().append("g")
    .attr("class", d => `node ${d.data.name.replace(/\s+/g,'')}`)
    .attr("transform", d => `translate(${d.y},${d.x})`);

// Add text first
const texts = node.append("text")
    .attr("dy", 4)
    .attr("text-anchor", "middle")
    .text(d => d.data.value ? `${d.data.name}: ${d.data.value}` : d.data.name);

// Now that text exists, add rectangles behind
node.each(function(d) {
    const textElem = d3.select(this).select("text");
    const bbox = textElem.node().getBBox();
    d3.select(this).insert("rect", "text")
        .attr("x", bbox.x - 6)    // 6px padding
        .attr("y", bbox.y - 2)    // vertical padding
        .attr("width", bbox.width + 12)
        .attr("height", bbox.height + 4)
        .attr("rx", 4)
        .attr("ry", 4)
        .attr("fill", function() {
            const cls = d.data.name.replace(/\s+/g,'');
            if(cls === "MessageSpec") return "#cce5ff";
            if(cls === "GLOBEBody") return "#d4edda";
            if(cls === "FilingInfo") return "#fff3cd";
            if(cls === "GeneralSection") return "#f8d7da";
            if(cls === "Summary") return "#e2e3e5";
            return "#fff";
        })
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5);
});
</script>
